<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>AN ARCHDAILY LEXICON - DEMO</title>
    <style media="screen">
      *{
        margin: 0;
        padding: 0;
        /* font-family: sans-serif; */
        font-family: 'Courier New', monospace;
      }
    </style>
    <link rel="stylesheet" href="./stylesheet.css">
    <!-- <link rel="stylesheet" href="./style-amended.css"> -->

    <!-- amended style for this page -->
    <style media="screen">
      .name_and_cover_container{
        display:flex;
        flex-direction:column;
        line-height:normal;
        text-align: center;
      }
      .name_tag_fix_height{
        min-height: 6em;
        max-height: 6em;
      }

      .sticky-search-box{
        position: sticky;
        position: -webkit-sticky;
        top: 0;
        z-index: 2;
        background-color: #ffffffa0;
      }
      /* unvisited link */
      .class_a:link {
        color: #c00000;
        text-decoration: none;
      }

      /* visited link */
      .class_a:visited {
        color: #c00000;
        text-decoration: none;
      }

      /* mouse over link */
      .class_a:hover {
        color: black;
        text-decoration: none;
      }
    </style>
    <!-- constants -->
    <script type="text/javascript" src="anarchdailylexicon/data/namelist.js"></script>
    <script type="text/javascript" src="anarchdailylexicon/data/urllist.js"></script>
    <script type="text/javascript" src="anarchdailylexicon_full/data/indexlist.js"></script>
  </head>
  <body>
    <header class="site-header" data-context="theme.topcontainer" data-hover-hint="header">
        <div class="logo-wrap" data-hover-hint="logo">
              <div class="logo">
                <a id="home-link" href="./index.html?position=1">
                <svg xmlns="http://www.w3.org/2000/svg" width="300px" viewBox="0 0 98.4533 46.3838"><defs><style>.a{font-size:12px;fill:#231815;font-family:CourierNewPSMT, Courier New;}.b{letter-spacing:0.1757em;}.c{letter-spacing:0.198em;}.d{letter-spacing:0.6673em;}.e{letter-spacing:-0.0151em;}</style></defs><text class="a" transform="translate(0.0004 9.4276)"><tspan class="b">TOWARD</tspan><tspan x="55.855" y="0">S</tspan><tspan class="c" x="63.0562" y="0"> </tspan><tspan class="b" x="72.6338" y="0">TH</tspan><tspan x="91.252" y="0">E</tspan><tspan class="d" x="0" y="14.3999">DIGITA</tspan><tspan x="91.252" y="14.3999">L</tspan><tspan class="e" x="0" y="28.7998">ARCHITECTONIC</tspan><tspan x="91.252" y="28.7998">S</tspan></text></svg>
                    <!-- <a href="./index.html" class="preserve-whitespace" style="color: #404040">TOWARDS THE DIGITAL ARCHITECTONIC</a> -->
                </a>
              </div>
        </div>
    </header>
    <script type="text/javascript" src="./checkhomeaddress.js"></script>

    <div class="project-container-wrapper">
      <div id="project-container" class="project-container">
        <!-- <section class="project-covers" data-context="page.gallery.covers"> -->
          <div class="project-title">
            Archdaily + Image Search
          </div>

          <div class="project-text-centered">
            <p>An image search engine majoring in architecture</p>
            <p>Please <a href='https://cors-anywhere.herokuapp.com/', target="_blank" class="class_a">enable CORS access</a> first!<br><br></p>
          </div>

          <!-- <div class="project-text-centered">
            <p>Current Image</p>
          </div> -->
          <div class="project-text-centered">
            <!-- crossorigin attribute is essential -->
            <!-- <img id="img" crossorigin='anonymous' src="https://upload.wikimedia.org/wikipedia/commons/3/3a/Cat03.jpg" width="100%"></img> -->
            <img id="img" crossorigin='anonymous' src="https://images.adsttc.com/media/images/5552/c7fd/e58e/ce8a/2600/00c6/slideshow/portada_FH03HuftonCrow.jpg?1431488470" width="40%"></img>
            <!-- <img id="img" crossorigin='anonymous' src="https://images.adsttc.com/media/images/62c8/3a5c/4cfd/3b5f/a26c/6773/slideshow/henrietta-house-moreysmith_7.jpg?1657289425" width="100%"></img> -->
          </div>

          <div id="search-box" class="project-text-centered sticky-search-box">
            <p>Paste a URL here to change image:</p>
            <div style="">
              <br>
              <input type="text" id="input_image_url" placeholder="Image URL here", class="project-text" style="width:90%; padding-top:0.2em;padding-bottom:0.2em;">
              <br>
              <br>
              <p id="indicator" style="color:#c00000">Initializing, please wait...</p>
              <br>
              <!-- use https://cors-anywhere.herokuapp.com/ as a temporary solution for CORS -->
              <input type="button" id="button_submit" value="Load New Image"  class="project-text-centered" style="width:12em; height:2em; padding-top:0;padding-bottom:0;">

              <input type="button" id="button_process" value="Search for Friends"  class="project-text-centered" style="width:12em; height:2em; padding-top:0;padding-bottom:0;">
            </div>
          </div>

          <div class="project-text-centered">
            <p>-</p>
          </div>

          <div id="div_search_results" class="project-container-gallery" style="gap: 10px;">
            <!-- search output here  -->
          </div>

          <div class="project-text-centered">-</div>
        <!-- </section> -->
      </div>
    </div>

    <script type="text/javascript">
      let results_index=[];
      let load_batch=50;
      let load_offset=0;
      let disable_scroll_loading=false;

      const remove_all_entries = function(){
        const container = document.getElementById("div_search_results");
        while (container.firstChild) {
          const c = container.lastChild
          container.removeChild(c);
          c.remove();
        }
        load_offset=0;
      };


      const add_entry=function(name, url_target, url_img='./gallery/thumbs/agentlamp.gif', target='_blank'){
        const container = document.getElementById("div_search_results");
        const ele_cover = document.createElement("div");
        ele_cover.className="project-cover-gallery";
        // console.log(v2);
        const ele_link = document.createElement("a");
        ele_link.href=url_target;

        const ele_wrapper=document.createElement('div');
        ele_wrapper.className="name_and_cover_container";

        const ele_img = document.createElement("img");
        const ele_name = document.createElement("p");
        ele_name.innerHTML=name;
        ele_name.className="name_tag_fix_height";

        ele_img.src=url_img;
        ele_img.style.width="100%";

        if (target!=null){
          ele_link.target=target;
        }

        ele_cover.appendChild(ele_link);
        ele_link.appendChild(ele_wrapper);
        ele_wrapper.appendChild(ele_img);
        ele_wrapper.appendChild(ele_name);


        // // cell mouseover behaviour
        // ele_cover.onmouseover = ele_cover.onmouseout = function (event) {
        //   let type = event.type;
        //   if (type=="mouseover"){
        //     ele_img.style.transform="scale(1.1)";
        //   }else{
        //     ele_img.style.transform="scale(1.0)";
        //   }
        // }

        container.appendChild(ele_cover);
      };
    </script>
    <!-- load tensorflow js (put js in the window) -->
    <script src="./anarchdailylexicon_full/data/tfjs/tf.min.js"></script>
    <!-- cross fetch package (put fetch in the window) -->
    <!-- <script src="https://unpkg.com/cross-fetch/dist/cross-fetch.js"></script> -->
    <script src="./anarchdailylexicon_full/data/cross-fetch/cross-fetch.js"></script>
    <!-- npyjs -->
    <script type="importmap">
      {
        "imports": {
          "npyjs":"./anarchdailylexicon_full/data/npyjs/index.js"
        }
      }
    </script>

    <script type="text/javascript">
      // define compoutations
      // argsort in JS:
      // https://stackoverflow.com/questions/46622486/what-is-the-javascript-equivalent-of-numpy-argsort
      const dsu = (arr1, arr2) => arr1
        .map((item, index) => [arr2[index], item]) // add the args to sort by
        .sort(([arg1], [arg2]) => arg1 - arg2) // sort by the args (ascending order)
        .map(([, item]) => item); // extract the sorted items

      // arange in JS:
      // https://stackoverflow.com/questions/3895478/does-javascript-have-a-method-like-range-to-generate-a-range-within-the-supp
      const arange = (dim) => Array.from({length: dim}, (x, i) => i);

      // define tfjs operations
      function dist_matrix(X,Y){
        // sqrt(max(0, x^2 + y^2 - 2dot(x,y)))
        const D = tf.sqrt(
            tf.maximum(0.,
                tf.sum(tf.pow(X, 2), axis=-1, keepDims =true).add(tf.sum(tf.pow(Y, 2), axis=-2, keepDims =true)).sub(tf.matMul(X, Y).mul(2))
            )
        );
        return D;
      }

      function dist_matrix2(X,Y){
        // x^2 + y^2 - 2dot(x,y)
        const D = tf.sum(tf.pow(X, 2), axis=-1, keepDims =true).add(tf.sum(tf.pow(Y, 2), axis=-2, keepDims =true)).sub(tf.matMul(X, Y).mul(2))
        return D;
      }

      function minmax_rescale (X, p) {
        // (x-min) / (max-min)
        const t_min = tf.min(X, axis=-1, keepDims =true);
        const t_max = tf.max(X, axis=-1, keepDims =true);
        const t_mid_level= tf.pow(X.sub(t_min).div(t_max.sub(t_min)), p);
        return tf.mean(t_mid_level, axis=0, keepDims =true);
      }

      function inverse(X){
        // 1/x
        return tf.pow(X,-1);
      }
    </script>

    <script type="text/javascript" src="anarchdailylexicon_full/data/cluster2index.js"></script>
    <script type="module">
      console.log("module starts");
      // read saved weight file (from npy binary)
      import npyjs from "npyjs";
      const div_indicator=document.getElementById("indicator");

      // =============================== encoder ===================================
      // weights
      let codebook; // codebook
      let library; // archdaily library

      // the core API approach
      const encoding_dim=1024;
      const codebook_dim=64;
      const codebook_path="./anarchdailylexicon_full/data/codebook.npy";

      // using clusters, faster, but less quality

      const use_clusters=true;
      const k_use = 50; // 50 clusters max
      const library_dim=30000; // 304260;
      const library_path="./anarchdailylexicon_full/data/k-library.npy";

      // using raw library, much slower to load, but better quality
      // loading files from google cloud storage
      // (CORS config is needed for the google clound storage, see https://cloud.google.com/storage/docs/configuring-cors)

      // const k_use =500;
      // const use_clusters=false;
      // const library_dim = 304260;
      // const library_path="./experiment/library.npy";

      const IMAGE_SIZE=224;

      div_indicator.innerHTML="Loading Codebook...";

      // read saved weight file (from npy binary)
      // import npyjs from "npyjs";
      // (function(){
        let n = new npyjs();

        console.log('loading codebook file');
        await n.load(codebook_path).then((res) => {
            // res has { data, shape, dtype } members.
            console.log('codebook shape', res.shape);
            codebook = tf.tensor(res.data).reshape(res.shape).transpose();
        });

        console.log('loading library file');
        await n.load(library_path).then((res) => {
            // res has { data, shape, dtype } members.
            console.log('library shape', res.shape);
            library = tf.tensor(res.data).reshape(res.shape).transpose();
        });
      // })();

      // get archdaily friends
      function get_friends_from_encoding(x) {
        return dist_matrix2(minmax_rescale(inverse(dist_matrix(x, codebook)),8), library);
      }

      // // for debug, load a sample from npy file
      // let sample; // to be replaced by machine learning output
      // await n.load("./experiment/sample3345.npy").then((res) => {
      //     // res has { data, shape, dtype } members.
      //     sample = tf.tensor(res.data).reshape(res.shape);
      // });
      //
      // let result = dsu(arange(library_dim), get_friends_from_encoding(sample).dataSync());
      // // console.log(model);
      // console.log('run model', result);

      // =============================== mobilenet ===================================

      // load the mobilenet model exported from keras to get the same model behavior in python
      // const model = await tf.loadLayersModel('https://storage.googleapis.com/zfguo_pretrained_models/mobilenet/model.json');
      console.log('loading mobilenet');
      div_indicator.innerHTML="Loading Mobilenet...";

      const model = await tf.loadLayersModel('./anarchdailylexicon_full/data/mobilenet/model.json');

      function get_window_box(img, n){
        const row = img.shape[0];
        const col = img.shape[1];

        const patch_size = Math.floor(Math.min(row,col) / n);
        const row_num = Math.ceil(row / patch_size);
        const col_num = Math.ceil(col / patch_size);

        let row_start = tf.floor(tf.linspace(0, row - patch_size - 1, row_num)).expandDims(0).tile([col_num, 1]).reshape([row_num*col_num]);
        let col_start = tf.floor(tf.linspace(0, col - patch_size - 1, col_num)).expandDims(1).tile([1, row_num]).reshape([row_num*col_num]);

        let row_end = row_start.add(patch_size);
        let col_end = col_start.add(patch_size);

        // normalize the bounding box
        // see https://js.tensorflow.org/api/2.0.0/#image.cropAndResize
        row_start=row_start.div(row);
        row_end=row_end.div(row);

        col_start=col_start.div(col);
        col_end=col_end.div(col);

        // list of [ymin, xmin, ymax, xmax]
        return tf.stack([row_start, col_start, row_end, col_end]).transpose();
      }

      function get_friends(img, k=10){
        // load the image and perform normalization
        // see corresponding model in keras for data preprocessing
        console.log('making image patches');
        const t_img = tf.browser.fromPixels(img).div(127).sub(2);

        // get image patches
        // something is wrong with patch-making
        const t_box = tf.concat([get_window_box(t_img, 2), get_window_box(t_img, 3)], 0);
        const t_inds=tf.zeros([t_box.shape[0]], 'int32');
        const t_img_batch = t_img.reshape([1, t_img.shape[0], t_img.shape[1], t_img.shape[2]]);

        // t_box: normalized box!
        const t_patch = tf.image.cropAndResize(t_img_batch, t_box, t_inds , [IMAGE_SIZE,IMAGE_SIZE])

        console.log('low-lv-coding');
        const low_lv_encoding = model.predict(t_patch);

        console.log('high-lv-coding');
        let result = dsu(arange(library_dim), get_friends_from_encoding(low_lv_encoding).dataSync()).slice(0,k);

        let result_real_id=[];

        // obtain the original index
        if (use_clusters){
          for (let r of result){
            result_real_id = result_real_id.concat(cluster2index[r]);
          }
        }else{
          result_real_id=result;
        }
        return [result, result_real_id];
      }
      console.log('loading finished');

      // =============================== run everything ===================================
      function run_img_search(k=10){
        const img = document.getElementById('img');
        const [result, result_real_id] = get_friends(img, k);
        results_index = result_real_id; // update id
        load_offset=0; // reset offset
      }

      function load_results_next_batch(){
        // remove_all_entries();
        for (let i=0;i<load_batch; i++){
          if (load_offset<results_index.length){
            const r_index=results_index[load_offset];
            const r_name=namelist[indexlist[r_index]].replaceAll('-',' ');
            const r_url=urllist[indexlist[r_index]];

            add_entry(r_name, r_url);
            load_offset+=1;
          } else {
            break;
          }
        }
        console.log('load_offset', load_offset);
      }

      // loading-while-scrolling
      window.onscroll = function(e) {
        // check search-box position
        const search_box=document.getElementById("search-box");
        // const box_top = search_box.getBoundingClientRect().top
        // console.log(box_top);
        // // const compensate_height = 0.5 * search_box.scrollHeight;


        const viewHeight = window.innerHeight;
        const scrollHeight=document.body.scrollHeight; // total height
        const scrollTop=Math.max(document.body.scrollTop, document.documentElement.scrollTop); // current top

        // this is optional, if not working, take it out
        // if (box_top<0){
        //   search_box.style.transform="translateY(" + scrollTop + "px)";
        //   search_box.style.zIndex ="2";
        //   search_box.style.backgroundColor ="#ffffffa0";
        // } else {
        //   search_box.style.transform="";
        // }

        // check loading process
        if (scrollHeight - (scrollTop + viewHeight) <= 10 && !disable_scroll_loading){
          console.log('load next batch');
          load_results_next_batch();
        }
      };

      // execute search while clicking button
      document.getElementById("button_submit").onclick= function(){
        const img_src = document.getElementById('input_image_url');
        try {
          new URL(document.getElementById('input_image_url').value);
          document.getElementById('img').src='https://cors-anywhere.herokuapp.com/' + document.getElementById('input_image_url').value;
          div_indicator.innerHTML="Image loaded!"
        } catch (_) {
          div_indicator.innerHTML="Seems not a URL?"
        }
      };

      document.getElementById("button_process").onclick=function(){
        div_indicator.innerHTML="Searching...";
        disable_scroll_loading=true;
        remove_all_entries();

        window.setTimeout(function(){
          run_img_search(k_use); // k_use determines the max-num of results
          load_results_next_batch();
          div_indicator.innerHTML="Finished!";
          disable_scroll_loading=false;
        }, 300);
      };

      div_indicator.innerHTML="Ready!"
    </script>
  </body>
</html>
