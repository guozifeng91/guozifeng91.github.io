<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title>AN ARCHDAILY LEXICON - DEMO</title>
  <style media="screen">
  *{
    margin: 0;
    padding: 0;
    /* font-family: sans-serif; */
    font-family: 'Courier New', monospace;
  }
  </style>
  <link rel="stylesheet" href="./stylesheet.css">
  <!-- <link rel="stylesheet" href="./style-amended.css"> -->

  <!-- amended style for this page -->
  <style media="screen">
  .name_and_cover_container{
    display:flex;
    flex-direction:column;
    line-height:normal;
    text-align: center;
  }

  .square_image_container{
    position:relative; width:100%; padding-bottom:100%; overflow:hidden;
  }

  .square_image_content{
    position:absolute; height:100%; width:100%; left:0; top:0; object-fit: cover;
  }

  .name_tag_fix_height{
    min-height: 6em;
    max-height: 6em;
  }

  .sticky-search-box{
    position: sticky;
    position: -webkit-sticky;
    top: 0;
    z-index: 2;
    background-color: #ffffffa0;
  }
  /* unvisited link */
  .class_a:link {
    color: #c00000;
    text-decoration: none;
  }

  /* visited link */
  .class_a:visited {
    color: #c00000;
    text-decoration: none;
  }

  /* mouse over link */
  .class_a:hover {
    color: black;
    text-decoration: none;
  }
  </style>
  <!-- constants -->
  <script type="text/javascript" src="anarchdailylexicon/data/namelist.js"></script>
  <script type="text/javascript" src="anarchdailylexicon/data/urllist.js"></script>
  <script type="text/javascript" src="anarchdailylexicon_full/data/indexlist.js"></script>
  <script type="text/javascript" src="anarchdailylexicon_full/data/cluster2index.js"></script>
</head>
<body>
  <header class="site-header" data-context="theme.topcontainer" data-hover-hint="header">
    <div class="logo-wrap" data-hover-hint="logo">
      <div class="logo">
        <a id="home-link" href="./index.html?position=1">
          <svg xmlns="http://www.w3.org/2000/svg" width="300px" viewBox="0 0 98.4533 46.3838"><defs><style>.a{font-size:12px;fill:#231815;font-family:CourierNewPSMT, Courier New;}.b{letter-spacing:0.1757em;}.c{letter-spacing:0.198em;}.d{letter-spacing:0.6673em;}.e{letter-spacing:-0.0151em;}</style></defs><text class="a" transform="translate(0.0004 9.4276)"><tspan class="b">TOWARD</tspan><tspan x="55.855" y="0">S</tspan><tspan class="c" x="63.0562" y="0"> </tspan><tspan class="b" x="72.6338" y="0">TH</tspan><tspan x="91.252" y="0">E</tspan><tspan class="d" x="0" y="14.3999">DIGITA</tspan><tspan x="91.252" y="14.3999">L</tspan><tspan class="e" x="0" y="28.7998">ARCHITECTONIC</tspan><tspan x="91.252" y="28.7998">S</tspan></text></svg>
          <!-- <a href="./index.html" class="preserve-whitespace" style="color: #404040">TOWARDS THE DIGITAL ARCHITECTONIC</a> -->
        </a>
      </div>
    </div>
  </header>
  <script type="text/javascript" src="./checkhomeaddress.js"></script>

  <div class="project-container-wrapper">
    <div id="project-container" class="project-container">
      <div class="project-title">
        Archdaily + Image Search
      </div>

      <div class="project-text-centered">
        <p>An image search engine majoring in architecture</p>
      </div>

      <div class="project-text-centered">
        <!-- crossorigin attribute is essential -->
        <!-- image size (i.e., width) matters! small image will get wrong image data for tensorflow -->

        <!-- this is a dunny image element for user to see -->
        <img id="img_thumb" crossorigin='anonymous' src="https://images.adsttc.com/media/images/5552/c7fd/e58e/ce8a/2600/00c6/slideshow/portada_FH03HuftonCrow.jpg?1431488470" width="40%"></img>

        <!-- this is the actual img element from which image data are read -->
        <img id="img" crossorigin='anonymous' src="https://images.adsttc.com/media/images/5552/c7fd/e58e/ce8a/2600/00c6/slideshow/portada_FH03HuftonCrow.jpg?1431488470" hidden="hidden"></img>
        <canvas id="img_canvas" hidden="hidden"></canvas>
      </div>

      <div id="search-box" class="project-text-centered sticky-search-box">
        <p>To change the current image (above), <a href='https://cors-anywhere.herokuapp.com/', target="_blank" class="class_a">enable CORS access</a> (once only) and then paste a new URL here:</p>
        <div style="">
          <br>
          <input type="text" id="input_image_url" placeholder="Image URL here", class="project-text" style="width:90%; padding-top:0.2em;padding-bottom:0.2em;">
          <br>
          <br>
          <p id="indicator" style="color:#c00000">Initializing, please wait...</p>
          <br>
          <!-- use https://cors-anywhere.herokuapp.com/ as a temporary solution for CORS -->
          <input type="button" id="button_submit" value="Change Image"  class="project-text-centered" style="width:12em; height:2em; padding-top:0;padding-bottom:0;">

          <input type="button" id="button_process" value="Search for Friends"  class="project-text-centered" style="width:12em; height:2em; padding-top:0;padding-bottom:0;">
        </div>
      </div>

      <div id="div_search_results" class="project-container-gallery" style="gap: 10px;">
        <!-- search output here  -->
      </div>

      <div class="project-text-centered">
        <p>-</p>
      </div>

      <div class="project-text">
        <p>This Web Demo encodes an image and compares the result with a pre-computed library to search for best-matching images.</p>
      </div>

      <div class="project-text">
        <p>The Wed Demo depends on the proxy service of <a href="https://cors-anywhere.herokuapp.com/" target="_blank" class="class_a">cors-anywhere.herokuapp.com</a> to bypass <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing" target="_blank" class="class_a">CORS restrictions</a> and load images from arbitrary URLs.</p>
      </div>

      <div class="project-text">
        <p>The encoding method depends on the <a href="https://github.com/tensorflow/tfjs-models/tree/master/mobilenet" target="_blank" class="class_a">Mobilenet</a> pre-trained model of <a href="https://www.tensorflow.org/js/tutorials" target="_blank" class="class_a">Tensorflow.js</a>.</p>
      </div>

      <div class="project-text">
        <p>The Web Demo also depends on <a href="https://www.npmjs.com/package/cross-fetch" target="_blank" class="class_a">cross-fetch</a>, <a href="https://github.com/aplbrain/npyjs" target="_blank" class="class_a">npyjs</a> to load the pre-computed library.</p>
      </div>

      <div class="project-text">
        <p>Currently the Web Demo has been tested only on PCs. All computations are executed on the client's device.</p>
      </div>

      <div class="project-text-centered">-</div>
      <!-- </section> -->
    </div>
  </div>

  <script async="" src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
  <script type="importmap">
    {
      "imports": {
        "npyjs":"./anarchdailylexicon_full/data/npyjs/index_no_await.js"
      }
    }
  </script>

  <!-- load tensorflow js (put js in the window) -->
  <script src="./anarchdailylexicon_full/data/tfjs/tf.min.js"></script>
  <!-- cross fetch package (put fetch in the window) -->
  <!-- <script src="https://unpkg.com/cross-fetch/dist/cross-fetch.js"></script> -->
  <script src="./anarchdailylexicon_full/data/cross-fetch/cross-fetch.js"></script>

  <script type="text/javascript">
    let results_index=[];
    let load_batch=50;
    let load_offset=0;
    let disable_scroll_loading=false;

    const unload_results = function(){
      results_index=[];
      load_offset=0;
    };

    const remove_all_entries = function(){
      const container = document.getElementById("div_search_results");
      while (container.firstChild) {
        const c = container.lastChild;
        container.removeChild(c);
        c.remove();
      }
      load_offset=0;
    };

    const add_entry = function(name, url_target, url_img='./gallery/thumbs/agentlamp.gif', target='_blank'){
      const container = document.getElementById("div_search_results");
      const ele_cover = document.createElement("div");
      ele_cover.className="project-cover-gallery";
      // console.log(v2);
      const ele_link = document.createElement("a");
      ele_link.href=url_target;

      const ele_wrapper=document.createElement('div');
      ele_wrapper.className="name_and_cover_container";
      const ele_wrapper_img=document.createElement('div');
      ele_wrapper_img.className="square_image_container";
      // ele_wrapper_img.style.display="block";
      // ele_wrapper_img.style="position:relative; width:100%; padding-bottom:100%; overflow:hidden;";

      const ele_img = document.createElement("img");
      const ele_name = document.createElement("p");
      ele_name.innerHTML=name;
      ele_name.className="name_tag_fix_height";

      ele_img.src=url_img;
      ele_img.className="square_image_content";
      // ele_img.style="position:absolute; height:100%; width:100%; left:0; top:0; object-fit: cover;";

      if (target!=null){ ele_link.target=target;}

      ele_cover.appendChild(ele_link);
      ele_link.appendChild(ele_wrapper);
      ele_wrapper.appendChild(ele_wrapper_img);
      ele_wrapper.appendChild(ele_name);
      ele_wrapper_img.appendChild(ele_img);

      container.appendChild(ele_cover);
    };
  </script>

  <script type="text/javascript">
    // image-patching without TF operations
    const IMAGE_SIZE=224; // the patch size used by the mobilenet model

    function get_window_box (rows, cols, n){
      const patch_size = Math.max(Math.floor(Math.min(rows,cols) / n),100);
      const row_num = Math.ceil(rows / patch_size);
      const col_num = Math.ceil(cols / patch_size);

      let boxes = [];

      for (let i=0; i<row_num; i++){
        const r_start = (i / (row_num-1)) * (rows - patch_size -1);
        for (let j=0; j<col_num; j++) {
          const c_start = (j / (col_num-1)) * (cols - patch_size -1);
          boxes.push([c_start,r_start,patch_size,patch_size]);
        }
      }
      return boxes;
    }

    function createArray(length) {
      // code for creating nd-array, taken from
      // https://stackoverflow.com/questions/966225/how-can-i-create-a-two-dimensional-array-in-javascript
      var arr = new Array(length || 0),
      i = length;

      if (arguments.length > 1) {
        var args = Array.prototype.slice.call(arguments, 1);
        while(i--) arr[length-1 - i] = createArray.apply(this, args);
      }
      return arr;
    }

    // the hidden image and canvas elements (for obtaining raw image data)
    const img_ele = document.getElementById("img");
    const canv_ele = document.getElementById("img_canvas");

    function update_patch_data(given_length=null) {
      // obtain patch data as nested arrays
      const drawsize=IMAGE_SIZE;
      const p_locs=get_window_box(img_ele.height,img_ele.width,2).concat(get_window_box(img_ele.height,img_ele.width,3));

      canv_ele.width=drawsize*p_locs.length;
      canv_ele.height=drawsize;

      let ctx = canv_ele.getContext("2d");
      for (let i=0;i<p_locs.length;i++){
        const [x,y,w,h] = p_locs[i];
        ctx.drawImage(img_ele, x, y, w, h, i*drawsize, 0, drawsize, drawsize);
      }

      let patch_num = given_length;
      if (patch_num==null){ patch_num=p_locs.length;}

      const patches =Array(patch_num);
      for (let idx=0;idx<patch_num;idx++){
        const i = idx%p_locs.length // index of p_locs
        const patch = createArray(drawsize, drawsize, 3);
        const patch_rgbs = ctx.getImageData(i*drawsize, 0, drawsize, drawsize).data;
        // the speed of for loop in JS is OK-ish
        for (let r=0;r<drawsize;r++){
          for (let c=0; c<drawsize; c++){
            const indice=(c + r*drawsize)*4;
            patch[r][c][0]=patch_rgbs[indice]/127.5-1;
            patch[r][c][1]=patch_rgbs[indice + 1]/127.5-1;
            patch[r][c][2]=patch_rgbs[indice + 2]/127.5-1;
          }
        }
        patches[idx]=patch;
      }
      return patches;
    };
  </script>

  <script type="text/javascript">
    // define compoutations
    // argsort in JS:
    // https://stackoverflow.com/questions/46622486/what-is-the-javascript-equivalent-of-numpy-argsort
    const dsu = (arr1, arr2) => arr1
    .map((item, index) => [arr2[index], item]) // add the args to sort by
    .sort(([arg1], [arg2]) => arg1 - arg2) // sort by the args (ascending order)
    .map(([, item]) => item); // extract the sorted items

    // arange in JS:
    // https://stackoverflow.com/questions/3895478/does-javascript-have-a-method-like-range-to-generate-a-range-within-the-supp
    const arange = (dim) => Array.from({length: dim}, (x, i) => i);

    // define tfjs operations
    function dist_matrix(X,Y){
      // sqrt(max(0, x^2 + y^2 - 2dot(x,y)))
      const D = tf.sqrt(
        tf.maximum(0.,
          tf.sum(tf.pow(X, 2), axis=-1, keepDims =true).add(tf.sum(tf.pow(Y, 2), axis=-2, keepDims =true)).sub(tf.matMul(X, Y).mul(2))
        )
      );
      return D;
    }

    function dist_matrix2(X,Y){
      // x^2 + y^2 - 2dot(x,y)
      const D = tf.sum(tf.pow(X, 2), axis=-1, keepDims =true).add(tf.sum(tf.pow(Y, 2), axis=-2, keepDims =true)).sub(tf.matMul(X, Y).mul(2))
      return D;
    }

    function minmax_rescale (X, p) {
      // (x-min) / (max-min)
      const t_min = tf.min(X, axis=-1, keepDims =true);
      const t_max = tf.max(X, axis=-1, keepDims =true);
      const t_mid_level= tf.pow(X.sub(t_min).div(t_max.sub(t_min)), p);
      return tf.mean(t_mid_level, axis=0, keepDims =true);
    }

    function inverse(X){
      return tf.pow(X,-1);
    }

    // =============================== implement frind-matching process as layers ===================================

    // minmaxrescale(inv(x)), pow=8 is hardcoded in the layer
    class MinMaxRescaleLayer extends tf.layers.Layer {
      constructor(p) {
        super({});
        this.p=p;
      }
      // In this case, the output is a scalar.
      computeOutputShape(inputShape) {
        return inputShape;
      }

      // call() is where we do the computation.
      call(input, kwargs) {
        const x = input[0].pow(-1); // inverse
        const output = tf.tidy(()=>{
          const t_min = x.min(1, true); // axis, keepDims
          const t_max = x.max(1, true); // axis, keepDims
          const t_mid_level= x.sub(t_min).div(t_max.sub(t_min)).pow(this.p);
          return t_mid_level.mean(0, true); // axis, keepDims
        });
        return output;
      }
      // Every layer needs a unique name.
      getClassName() { return 'MinMaxRescaleLayer'; }
    }

    // dist matrix
    class DistMatrixLayer extends tf.layers.Layer {
      constructor(y) {
        // y: the 2d array with which dist matrix will be computed
        super({});
        this.y=y;
      }

      // In this case, the output is a scalar.
      computeOutputShape(inputShape) {
        return [inputShape[0], this.y.shape[1]];
      }

      // call() is where we do the computation.
      call(input, kwargs) {
        // const [x,y] = input;
        const x=input[0];
        const y=this.y;
        const output = tf.tidy(()=>{
          const x2 = x.pow(2).sum(1, true); // axis, keepDims
          const y2 = y.pow(2).sum(0, true); // axis, keepDims
          const xy = x.matMul(y).mul(2);
          return tf.maximum(x2.add(y2).sub(xy),0).sqrt();
        });
        return output;
      }
      // Every layer needs a unique name.
      getClassName() { return 'DistMatrixLayer'; }
    }

    class DistMatrix2Layer extends tf.layers.Layer {
      constructor(y) {
        // y: the 2d array with which dist matrix will be computed
        super({});
        this.y=y;
      }

      // In this case, the output is a scalar.
      computeOutputShape(inputShape) {
        return [inputShape[0], this.y.shape[1]];
      }

      // call() is where we do the computation.
      call(input, kwargs) {
        const x = input[0];
        const y = this.y;
        const output = tf.tidy(()=>{
          const x2 = x.pow(2).sum(1,true);
          const y2 = y.pow(2).sum(0,true);
          const xy = x.matMul(y).mul(2);
          return x2.add(y2).sub(xy);
        });
        return output;
      }
      // Every layer needs a unique name.
      getClassName() { return 'DistMatrix2Layer'; }
    }

    function get_friend_matching_model(library, codebook, encoding_dim=1024, pow=8){
      const input_encoding = tf.input({shape: [encoding_dim]});

      const dist1 = new DistMatrixLayer(codebook).apply(input_encoding);
      const dist_res = new MinMaxRescaleLayer(pow).apply(dist1);
      const dist2 = new DistMatrix2Layer(library).apply(dist_res);

      return tf.model({inputs: input_encoding, outputs: dist2});
    }
  </script>

  <script type="text/javascript">
    // all constants
    // the core API approach
    const encoding_dim=1024;
    const codebook_dim=64;
    const codebook_path="./anarchdailylexicon_full/data/codebook.npy";

    // using clusters, faster, but less quality
    // based on the test,as long as the images are well patched, clusters are good enough
    const use_clusters=true;
    const k_use = 50; // 50 clusters max
    const library_dim=30000; // 304260;
    const library_path="./anarchdailylexicon_full/data/k-library.npy";

    const div_indicator=document.getElementById("indicator");
  </script>

  <script type="module">
    // for mobile device: this module requires IOS 15+
    console.log("module starts");

    // read saved weight file (from npy binary)
    import npyjs from "npyjs";

    let friend_matching_model=null;
    let patch_encoding_model=null;

    // try to avoid await in the code
    (function() {
      console.log('loading codebook');
      div_indicator.innerHTML="Loading Codebook...";

      let NPYJS = new npyjs();

      NPYJS.load(codebook_path).then((res) => {
        // first load codebook
        let codebook = tf.tensor(res.data).reshape(res.shape).transpose();
        console.log('loading library');
        NPYJS.load(library_path).then((res) => {
          // then load library
          let library = tf.tensor(res.data).reshape(res.shape).transpose();
          // build friend-matching-model
          friend_matching_model = get_friend_matching_model(library, codebook, encoding_dim);

          div_indicator.innerHTML="Loading Mobilenet...";
          console.log('loading mobilenet');
          // then load mobilenet
          tf.loadLayersModel('./anarchdailylexicon_full/data/mobilenet/model.json').then((res)=>{
            patch_encoding_model=res;
            // maybe put onclick here?
            div_indicator.innerHTML="Ready!";
          });
        });
      });
    })();

    // =============================== mobilenet ===================================
    // load the mobilenet model exported from keras to get the same model behavior in python
    function run_full_model(given_patch_num=25){
      // note on given_patch_num:

      // it is observed that tensorflow has a serious memory leak when changing the input batch size
      // this memory leak appears to be with WebGL and cannot be fixed by tf.tidy() or tf.dispose().
      // more specifially, everytime the input batch size changes (i.e., feed a new input to model.predict()),
      // a significant memory usage increase can be seen from the task manager, and meanwhile, tf.memory() returns wrong results which says the memory usage is stable.

      // sadly, it seems this memory leak cannot be fixed by tf.tidy() or tf.dispose(),
      // dispite the many attempts (e.g., implement patch-sampling process with / without tf framework) and research that have been made.

      // currently, a temporary solution of this problem is to fix the input batch size that is fed to the mobilenet model.
      // this solution does not alter the patch-sampling algorithm, it simply repeats the sampled patches if they are not enough to fill the batch,
      // or discard patches that exceeds the batch size limit.

      const t_patches=tf.tensor(update_patch_data(given_patch_num));
      const t_encoding = patch_encoding_model.predict(t_patches);
      const t_outputs = friend_matching_model.predict(t_encoding);
      const output_data = t_outputs.dataSync();
      tf.dispose([t_patches, t_encoding, t_outputs]);
      return output_data;
    }

    // =============================== high-level functions ===================================
    function run_img_search(k){
      // k: use the first-k returned results
      // this value corresponds to the actual image number, when use_clusters=false
      // or the cluster number, when use_clusters=true
      // in the latter case, the actual image num is the sum of images of each cluster
      const result_encoding = tf.tidy(()=>{
        return run_full_model();
      });
      let result = dsu(arange(library_dim), result_encoding).slice(0,k);
      let result_real_id=[];
      // obtain the original index
      if (use_clusters){
        for (let r of result){
          result_real_id = result_real_id.concat(cluster2index[r]);
        }
      }else{
        result_real_id=result;
      }

      // set index data for the user interface
      results_index = result_real_id; // update id
      load_offset=0; // reset offset
    }

    function load_results_next_batch(){
      // load the next batch to the result list area
      for (let i=0;i<load_batch; i++){
        if (load_offset<results_index.length){
          const r_index=results_index[load_offset];
          const r_name=namelist[indexlist[r_index]].replaceAll('-',' ');
          const r_url=urllist[indexlist[r_index]];

          const r_url_thumb = "https://storage.googleapis.com/zfguo_pretrained_models/thumbs/" + r_index + ".jpg";
          add_entry(r_name, r_url, r_url_thumb);
          load_offset+=1;
        } else {
          break;
        }
      }
    }

    // =============================== user-interface functions ===================================

    // loading-while-scrolling
    window.onscroll = function(e) {
      // check search-box position
      const search_box=document.getElementById("search-box");

      const viewHeight = window.innerHeight;
      const scrollHeight=document.body.scrollHeight; // total height
      const scrollTop=Math.max(document.body.scrollTop, document.documentElement.scrollTop); // current top

      // check loading process
      if (scrollHeight - (scrollTop + viewHeight) <= 10 && !disable_scroll_loading){
        console.log('load next batch');
        load_results_next_batch();
      }
    };

    // execute search while clicking button
    document.getElementById("button_submit").onclick= function(){
      const img_src = document.getElementById('input_image_url');
      try {
        new URL(img_src.value);
        // update both the data and the thumb
        document.getElementById('img').src='https://cors-anywhere.herokuapp.com/' + img_src.value;
        document.getElementById('img_thumb').src='https://cors-anywhere.herokuapp.com/' + img_src.value;
        div_indicator.innerHTML="Image loaded!";
        remove_all_entries();
        unload_results();
      } catch (error) {
        div_indicator.innerHTML="Seems not a URL?";
      }
    };

    document.getElementById("button_process").onclick=function(){
      div_indicator.innerHTML="Searching...";
      disable_scroll_loading=true;
      remove_all_entries();
      unload_results();

      window.setTimeout(function(){
        run_img_search(k_use); // k_use determines the max-num of results
        load_results_next_batch();
        div_indicator.innerHTML="Finished!";
        disable_scroll_loading=false;
      }, 300);
    };
  </script>
</body>
</html>
